<!DOCTYPE html>
<html>
<head>
  <!--LINKS-->
  <!--This checks if the device is accessing from a tiny screen and switches
    to a mobile friendly version of the website.-->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <!--Link to styles.css for page styling.-->
  <link rel="stylesheet" type="text/css" href="styles.css">
  <link href="https://fonts.googleapis.com/css?family=Cinzel+Decorative" rel="stylesheet">
  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <!--Link to Flappy Bird JS file-->
  <script src="game-sprite.js"></script>

	<style>
	canvas {
		display: block;
		position: absolute;
		margin: auto;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
	}
	</style>
</head>



<body>
<!--NAVBAR-->
<!--See tutorial here: https://www.w3schools.com/bootstrap/bootstrap_navbar.asp-->
<!--See Mobile Example here: https://getbootstrap.com/docs/3.3/components/#navbar-->
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">WebSiteName</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home<span class="sr-only">(current)</span></a></li>
        <li class="active"><a href="game.html">Play</a></li>
        <li><a href="store.html">Store</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="chat.html">Chat</a></li>
            <li><a href="profile_search.html">People Search</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="admin.html">Admin Login</a></li>
            <li role="separator" class="divider"></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="profile.html"><span class="glyphicon glyphicon-user"></span> Profile</a></li>
        <li><a href="login_register.html"><span class="glyphicon glyphicon-log-in"></span> Login/Logout</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<div style="padding-left:16px">
  <h2>FlappyBird Game here:</h2>
  <p>Some content..</p>
</div>

<!--Javascript for Flappy Bird game-->
<!--Tutorial found here: https://www.youtube.com/watch?v=riUx2G75mas-->
<script>

var
canvas,
ctx,
width,
height,

frames = 0,
score = 0,
best = 0,

currentstate,
states = {
  Splash: 0, Game: 1, Score: 2
},

bird = {
  x: 80,
  y: 0,
  frame: 0,
  animation: [0, 1, 2, 1],
  rotation: 0,
  gravity: 0.25,
  _jump: 4.6, 

  _jump: function(){
    this.velocity = -this._jump;
  },

  update: function(){
    var n = currentstate === states.Splash ? 10 : 5;
    this.frame += frames % n === 0 ? 1 : 0;
    this.frame %= this.animation.length;

    if(currentstate === states.Splash){
      this.y = height - 280 + 5*Math.cos(frames/10);
      this.rotation = 0;
    } else{
      this.velocity += this.gravity;
      this.y += this.velocity;

      if(this.y >= height - s_fg.height-10){
        this.y = height - s_fg.height-10;
        if (currentstate === states.Game){
          currentstate = states.Score;
        }
        this.velocity = this._jump;
      }

      if(this.velocity >= this._jump){
        this.frame = 1;
        this.rotation = Math.min(Math.PI/2, this.rotation + 0.3);
      }else{
        this.rotation = -0.3;
      }
    }
  },
  draw: function(ctx){
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);

    var n = this.animation[this.frame];
    s_bird[n].draw(ctx, -s_bird[n].width/2, -s_bird[n].height/2);
    ctx.restore();
  }
},

pipes = {
  _pipes: [],

  reset: function(){
    this._pipes = [];
  },

  update: function(){
    if(frames % 100 == 0){
      var _y = height - (s_pipeSouth.height+s_fg.height+120+200+Math.random());
      this._pipes.push({
        x: 500,
        y: _y,
        width: s_pipeSouth.width,
        height: s_pipeSouth.height
      });
    }
    for (var i = 0, len = this._pipes.length; i < len; i++){
      var p = this._pipes[i];

      if (i == 0){
        var cx = Math.min(Math.max(bird.x, p.x), p.x+p.width);
        var cy1 = Math.min(Math.max(bird.y, p.y), p.y+p.height);
        var cy2 = Math.min(Math.max(bird.y, p.y+p.height+80), p.y+2*p.height+80);

        var dx = bird.x - cx;
        var dy1 = bird.y - cy1;
        var dy2 = bird.y - cy2;

        var d1 = dx*dx + dy1*dy1;
        var d2 = dx*dx + dy2*dy2;

        var r = bird.radius*bird.radius;

        if (r > d1 || r > d2){
          currentstate = states.Score;
        }
      }

      p.x -= 2;
      if(p.x < -50){
        this._pipes.splice(i, 1);
        i--;
        len--;
      }
    }
  },
  draw: function(ctx){
    for(var i = 0, len = this._pipes.length; i < len; i++){
      var p = this._pipes[i];
      s_pipeSouth.draw(ctx, p.x, p.y);
      s_pipeNorth.draw(ctx, p.x, p.y+80+p.height);
    }
  }
};

function onpress(evt){

  switch (currentstate){
    case states.Splash:
      currentstate = states.Game;
      bird.jump();
      break;

    case states.Game:
      bird.jump();
      break;

    case states.Score:
      break;
  }
}

function main(){
  canvas = document.createElement("canvas");

  width = window.innerWidth;
  height = window.innerHeight;

  var evt = "touchstart";
  if(width >= 500){
    width = 320;
    height = 480;
    canvas.style.border = "1px solid #000";
    evt = "mousedown";
  }

  document.addEventListener(evt, onpress);

  canvas.width = width;
  canvas.height = height;
  ctx = canvas.getContext("2d");

  currentstate = states.Splash;

  document.body.appendChild(canvas);
  var img = new Image();
  img.onload = function(){
    initSprites(this);
    ctx.fillStyle = s_bg.color;
    run();
  }
  img.src = "sheet.png";
}

function run(){
  var loop = function(){
    update();
    render();
    window.requestAnimationFrame(loop, canvas);
  }
  window.requestAnimationFrame(loop, canvas);
}

function update(){
  frames++;
  if(currentstate !== states.Score){
    fgpos = (fgpos - 2) % 14;
  }
  if (currentstate === states.Game){
    pipes.update();
  }
  bird.update();
}

function render(){
  ctx.fillRect(0, 0, width, height);

  s_bg.draw(ctx, 0, height - s_bg.height);
  s_bg.draw(ctx, s_bg.width, height - s_bg.height);

  pipes.draw(ctx);
  bird.draw(ctx);

  s_fg.draw(ctx, fgpos, height - s_fg.height);
  s_fg.draw(ctx, fgpos+s_fg.width, height - s_fg.height);

  var width2 = width/2;

  if(currentstate === states.Splash){
    s_splash.draw(ctx, width2 - s_splash.width/2, height - 300);
    s_text.GetReady.draw(ctx, width2 - s_text.GetReady.width/2, height - 380);
  }
}

</script>

</body>
</html>
